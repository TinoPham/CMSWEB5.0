define(function(){var n=function(n,t,i,r,u,f,e){function c(n){t.form=n}function l(n){e.UserInfo=n;n!=null&&(e.UserInfo.authenticated=!0)}var o,s,a,h;t.$on("redirectToLogin",function(){i.go("login")});t.$on("redirectToRegister",function(){i.go("register")});t.edit=!1;t.InitLogin=function(i){var r;c(i);var s=u.get("usertoken"),o=f.decode(s),r=null;o!=null&&(r=JSON.parse(o));r!=null?(t.edit=!1,e.UserInfo=r,n.UserInfo=e.UserInfo,t.User=r,t.login()):(t.edit=!0,r={UserName:null,Password:null,Name:null,ID:0,authenticated:!1},t.User=r)};t.InitRegister=function(n){c(n);t.edit=!0;t.User=null;e.UserInfo==null?(t.User={UserName:null,Password:null,Name:null,ID:0,ConfirmPassword:null},$("#_btnsave").attr("value","Register")):(t.User={UserName:e.UserInfo.UserName,Password:null,Name:e.UserInfo.Name,ID:e.UserInfo.ID,ConfirmPassword:null},$("#_btnsave").attr("value","Save"))};o=function(r){t.edit=!1;l(r);n.UserInfo=e.UserInfo;var o=f.encode(r);return u.set("usertoken",o),i.current.name=="login"&&i.go("home.database"),r};s=function(){alert("login errr")};t.logout=function(){n.UserInfo=null;e.UserInfo=null;u.remove("usertoken");n.$broadcast("redirectToLogin",null)};t.login=function(n){var i=t.form,r;if(angular.isDefined(i)&&angular.isDefined(i.loginForm)!=null&&!i.loginForm.$valid){n.preventDefault();return}r=e.LogIn(t.User);r.then(function(n){o(n)},function(n){return s(n),n},function(n){return n})};t.CancelRegister=function(){var n=r.ret;n!=null?i.go(n):Window.history.back()};t.register=function(){var n=null;n=t.User.UserID>0?e.editAccount(t.User):e.addAccount(t.User);n.then(function(n){o(n)},function(n){return s(n),n},function(n){return n})};n.UserInfo=e.UserInfo;a=i.current;e.checkaccount().then(function(n){n=="0"&&(h="redirectToRegister")});(h==null||h==undefined)&&t.InitLogin()};return n.$inject=["$rootScope","$scope","$state","$stateParams","Cookies","Base64","ApiService"],n});